{% extends "base.html" %}

{% block title %}Admin Dashboard - AI Research Agent{% endblock %}

{% block content %}
<div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1 style="color: var(--text-primary);">Admin Dashboard</h1>
        <div style="display: flex; gap: 1rem;">
            <a href="{{ url_for('manage_knowledge') }}" class="btn btn-secondary">ğŸ“š Manage Knowledge</a>
            <a href="{{ url_for('manage_company_info') }}" class="btn btn-secondary">ğŸ“š Company Knowledge</a>
            <a href="{{ url_for('admin_users') }}" class="btn btn-secondary">ğŸ‘¥ Users</a>
            <a href="{{ url_for('admin_queries') }}" class="btn btn-secondary">ğŸ“Š All Queries</a>
        </div>
    </div>
    
    <!-- Key Metrics -->
    <div class="stats-grid">
        <div class="stat-card">
            <h3>ğŸ‘¥ Total Users</h3>
            <div class="stat-number">{{ total_users }}</div>
            <p>Active users in system</p>
        </div>
        
        <div class="stat-card">
            <h3>ğŸ’¬ Total Queries</h3>
            <div class="stat-number">{{ total_queries }}</div>
            <p>All research queries</p>
        </div>
        
        <div class="stat-card">
            <h3>âœ… Completed</h3>
            <div class="stat-number">{{ completed_queries }}</div>
            <p>Successfully processed</p>
        </div>
        
        <div class="stat-card">
            <h3>âŒ Failed</h3>
            <div class="stat-number">{{ failed_queries }}</div>
            <p>Processing errors</p>
        </div>
    </div>
    
    <!-- Task Type Breakdown -->
    <div class="card" style="margin-top: 2rem;">
        <h2 style="color: var(--text-primary); margin-bottom: 1rem;">ğŸ“ˆ Task Type Breakdown</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 1rem;">
            {% for task_type, count in task_breakdown.items() %}
            <div style="background: var(--card-bg); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color); flex: 1; min-width: 150px;">
                <div style="font-weight: 600; color: var(--accent-green); margin-bottom: 0.5rem;">{{ task_type }}</div>
                <div style="font-size: 1.8rem; font-weight: 700; color: var(--text-primary);">{{ count }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Recent Queries -->
    <div class="card" style="margin-top: 2rem;">
        <h2 style="color: var(--text-primary); margin-bottom: 1rem;">ğŸ‘¥ Recent Users</h2>
        
        {% if recent_users %}
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>User Type</th>
                    <th>Total Queries</th>
                    <th>Joined</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for user in recent_users %}
                <tr>
                    <td><strong>{{ user.username }}</strong></td>
                    <td>
                        {% if user.is_admin %}
                            <span class="badge" style="background-color: var(--accent-green); color: white; padding: 0.3rem 0.8rem; border-radius: 4px;">Admin</span>
                        {% else %}
                            <span class="badge badge-primary">User</span>
                        {% endif %}
                    </td>
                    <td>{{ user.queries.count() }}</td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        {% if not user.is_admin and user.id != session.user_id %}
                            <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this user and all their queries?');">
                                <button type="submit" class="btn btn-danger" style="font-size: 0.85rem; padding: 0.5rem 1rem; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">ğŸ—‘ï¸ Delete</button>
                            </form>
                        {% else %}
                            <span style="color: var(--text-secondary); font-size: 0.85rem;">-</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No users found</p>
        {% endif %}
    </div>
    
    <!-- Recent Queries -->
    <div class="card" style="margin-top: 2rem;">
        <h2 style="color: var(--text-primary); margin-bottom: 1rem;">ğŸ“ Recent Queries</h2>
        
        {% if recent_queries %}
        <table>
            <thead>
                <tr>
                    <th>User</th>
                    <th>Query</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Time</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for query in recent_queries %}
                <tr>
                    <td><strong>{{ query.user.username }}</strong></td>
                    <td>{{ query.query_text[:50] }}{% if query.query_text|length > 50 %}...{% endif %}</td>
                    <td><span class="badge badge-primary">{{ query.task_type }}</span></td>
                    <td>
                        <span class="status-badge status-{{ query.status }}">
                            {% if query.status == 'completed' %}
                                âœ“ Completed
                            {% elif query.status == 'processing' %}
                                â³ Processing
                            {% else %}
                                âœ— Failed
                            {% endif %}
                        </span>
                    </td>
                    <td>{{ query.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    <td>
                        <a href="{{ url_for('admin_user_queries', user_id=query.user_id) }}" class="btn btn-secondary" style="font-size: 0.85rem; padding: 0.5rem 1rem;">View All</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No queries yet</p>
        {% endif %}
    </div>
</div>

<script>
    // Update stats periodically
    setInterval(function() {
        location.reload();
    }, 30000); // Refresh every 30 seconds
</script>
{% endblock %}