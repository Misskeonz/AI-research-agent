{% extends "base.html" %}

{% block title %}Settings - AI Research Agent{% endblock %}

{% block extra_styles %}
<style>
    .settings-grid {
        display: grid;
        gap: 2rem;
    }
    
    .setting-card {
        background: var(--white);
        padding: 2rem;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }
    
    .setting-card h3 {
        color: var(--accent-green);
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid var(--border-color);
    }
    
    .stat-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .stat-item {
        background: var(--card-bg);
        padding: 1.5rem;
        border-radius: 8px;
        text-align: center;
        border: 1px solid var(--border-color);
    }
    
    .stat-item .number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--accent-green);
        margin-bottom: 0.5rem;
    }
    
    .stat-item .label {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
    }
    
    .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-content {
        background: var(--white);
        padding: 2rem;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .modal-header h2 {
        color: var(--text-primary);
        font-size: 1.5rem;
        margin: 0;
    }
    
    .close-btn {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: var(--text-secondary);
    }
    
    .close-btn:hover {
        color: var(--text-primary);
    }
    
    .modal-buttons {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
    
    .modal-buttons button {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 style="margin-bottom: 2rem; color: var(--text-primary);">Settings</h1>
    
    <div class="settings-grid">
        <!-- Account Settings -->
        <div class="setting-card">
            <h3>üë§ Account Information</h3>
            <div class="form-group">
                <label>Username</label>
                <input type="text" value="{{ user.username }}" disabled>
            </div>
            <div class="form-group">
                <label>Member Since</label>
                <input type="text" value="{{ user.created_at.strftime('%B %d, %Y') }}" disabled>
            </div>
            <button class="btn btn-primary" style="margin-top: 1rem;" onclick="openChangePasswordModal()">üîê Change Password</button>
        </div>
        
        <!-- Statistics -->
        <div class="setting-card">
            <h3>üìä Your Statistics</h3>
            <div id="statsContainer" class="stat-grid">
                <div class="stat-item">
                    <div class="number" id="totalQueries">-</div>
                    <div class="label">Total Queries</div>
                </div>
                <div class="stat-item">
                    <div class="number" id="completedQueries">-</div>
                    <div class="label">Completed</div>
                </div>
                <div class="stat-item">
                    <div class="number" id="failedQueries">-</div>
                    <div class="label">Failed</div>
                </div>
            </div>
            
            <h4 style="margin-top: 2rem; margin-bottom: 1rem; color: var(--text-primary); font-weight: 600;">Task Type Breakdown</h4>
            <div id="taskBreakdown" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
        </div>
        
        <!-- API Settings -->
        <div class="setting-card">
            <h3>‚öôÔ∏è API Configuration</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Your API key is securely stored as an environment variable. Never share your API key with anyone.
            </p>
            <div class="alert alert-info">
                <strong>API Key Status:</strong> ‚úì Configured
            </div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                To update your API key, edit the <code>.env</code> file in your project directory:
            </p>
            <pre style="background: var(--card-bg); padding: 1rem; border-radius: 6px; margin-top: 1rem;">ANTHROPIC_API_KEY=your-key-here</pre>
        </div>
        
        <!-- Quick Links -->
        <div class="setting-card">
            <h3>üîó Quick Links</h3>
            <ul style="list-style: none; padding: 0;">
                <li style="margin-bottom: 1rem;">
                    <a href="https://console.anthropic.com" target="_blank" style="color: var(--accent-green); text-decoration: none; font-weight: 600;">
                        ‚Üí Anthropic Console
                    </a>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem;">Manage your API keys and usage</p>
                </li>
                <li style="margin-bottom: 1rem;">
                    <a href="https://docs.anthropic.com" target="_blank" style="color: var(--accent-green); text-decoration: none; font-weight: 600;">
                        ‚Üí Claude Documentation
                    </a>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem;">Learn more about Claude capabilities</p>
                </li>
                <li>
                    <a href="{{ url_for('logout') }}" style="color: #DC3545; text-decoration: none; font-weight: 600;">
                        ‚Üí Logout
                    </a>
                    <p style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem;">Sign out from your account</p>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div id="passwordModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Change Password</h2>
            <button class="close-btn" onclick="closeChangePasswordModal()">&times;</button>
        </div>
        
        <div id="passwordMessage"></div>
        
        <form id="changePasswordForm">
            <div class="form-group">
                <label for="currentPassword">Current Password</label>
                <input type="password" id="currentPassword" name="currentPassword" required>
            </div>
            
            <div class="form-group">
                <label for="newPassword">New Password</label>
                <input type="password" id="newPassword" name="newPassword" required>
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">Confirm New Password</label>
                <input type="password" id="confirmPassword" name="confirmPassword" required>
            </div>
            
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Change Password</button>
            </div>
        </form>
    </div>
</div>

<script>
// Modal functions
function openChangePasswordModal() {
    document.getElementById('passwordModal').classList.add('active');
    document.getElementById('changePasswordForm').reset();
    document.getElementById('passwordMessage').innerHTML = '';
}

function closeChangePasswordModal() {
    document.getElementById('passwordModal').classList.remove('active');
    document.getElementById('changePasswordForm').reset();
    document.getElementById('passwordMessage').innerHTML = '';
}

// Close modal when clicking outside
document.getElementById('passwordModal').addEventListener('click', function(event) {
    if (event.target === this) {
        closeChangePasswordModal();
    }
});

// Handle password change form submission
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const messageDiv = document.getElementById('passwordMessage');
    
    // Validation
    if (newPassword !== confirmPassword) {
        messageDiv.innerHTML = '<div class="alert alert-error">New passwords do not match!</div>';
        return;
    }
    
    if (newPassword.length < 6) {
        messageDiv.innerHTML = '<div class="alert alert-error">New password must be at least 6 characters long!</div>';
        return;
    }
    
    try {
        const response = await fetch('/api/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            messageDiv.innerHTML = '<div class="alert alert-success">‚úì Password changed successfully!</div>';
            setTimeout(() => {
                closeChangePasswordModal();
                messageDiv.innerHTML = '';
            }, 1500);
        } else {
            messageDiv.innerHTML = `<div class="alert alert-error">${data.error || 'Error changing password'}</div>`;
        }
    } catch (error) {
        console.error('Error:', error);
        messageDiv.innerHTML = '<div class="alert alert-error">An error occurred. Please try again.</div>';
    }
});

// Load statistics
fetch('/api/statistics')
    .then(response => response.json())
    .then(data => {
        document.getElementById('totalQueries').textContent = data.total_queries;
        document.getElementById('completedQueries').textContent = data.completed_queries;
        document.getElementById('failedQueries').textContent = data.failed_queries;
        
        // Task breakdown
        const taskBreakdown = document.getElementById('taskBreakdown');
        for (const [task, count] of Object.entries(data.task_breakdown)) {
            const badge = document.createElement('span');
            badge.className = 'badge badge-primary';
            badge.textContent = `${task}: ${count}`;
            taskBreakdown.appendChild(badge);
        }
    })
    .catch(error => console.error('Error loading statistics:', error));
</script>
{% endblock %}